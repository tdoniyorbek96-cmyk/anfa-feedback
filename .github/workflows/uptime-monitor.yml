name: Anfa Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Oldingi holatni tiklash
        uses: actions/cache@v4
        with:
          path: .monitor_state
          key: anfa-monitor-state
          restore-keys: |
            anfa-monitor-state

      - name: Papkani yaratish
        run: mkdir -p .monitor_state

      - name: Oldingi holatni oâ€˜qish
        id: prev
        run: |
          FE_PREV="unknown"
          BE_PREV="unknown"

          if [ -f .monitor_state/frontend.txt ]; then
            FE_PREV=$(cat .monitor_state/frontend.txt)
          fi

          if [ -f .monitor_state/backend.txt ]; then
            BE_PREV=$(cat .monitor_state/backend.txt)
          fi

          echo "fe_prev=$FE_PREV" >> $GITHUB_OUTPUT
          echo "be_prev=$BE_PREV" >> $GITHUB_OUTPUT

      - name: Frontendni tekshirish
        id: fe
        run: |
          set +e
          curl -fsS -m 15 https://anfa-feedback.uz >/dev/null
          if [ "$?" = "0" ]; then
            echo "status=up" >> $GITHUB_OUTPUT
          else
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Backendni tekshirish
        id: be
        run: |
          set +e
          curl -fsS -m 15 https://api.anfa-feedback.uz/health >/dev/null
          if [ "$?" = "0" ]; then
            echo "status=up" >> $GITHUB_OUTPUT
          else
            echo "status=down" >> $GITHUB_OUTPUT
          fi

      - name: Holatni saqlash
        run: |
          echo "${{ steps.fe.outputs.status }}" > .monitor_state/frontend.txt
          echo "${{ steps.be.outputs.status }}" > .monitor_state/backend.txt

      - name: Telegramga xabar yuborish
        if: steps.prev.outputs.fe_prev != steps.fe.outputs.status || steps.prev.outputs.be_prev != steps.be.outputs.status
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          FE_PREV="${{ steps.prev.outputs.fe_prev }}"
          BE_PREV="${{ steps.prev.outputs.be_prev }}"
          FE_NOW="${{ steps.fe.outputs.status }}"
          BE_NOW="${{ steps.be.outputs.status }}"

          TIME_UTC=$(date -u '+%Y-%m-%d %H:%M:%S')

          MSG="ðŸ“¡ ANFA MONITORING OGÐžHLANTIRISHI\n"
          MSG="${MSG}ðŸ•’ Vaqt (UTC): ${TIME_UTC}\n\n"

          if [ "$FE_PREV" != "$FE_NOW" ]; then
            if [ "$FE_NOW" = "down" ]; then
              MSG="${MSG}ðŸš¨ FRONTEND: ISHLAMAYAPTI (DOWN)\n"
            else
              MSG="${MSG}âœ… FRONTEND: QAYTA ISHLAYAPTI (UP)\n"
            fi
          fi

          if [ "$BE_PREV" != "$BE_NOW" ]; then
            if [ "$BE_NOW" = "down" ]; then
              MSG="${MSG}ðŸš¨ BACKEND: ISHLAMAYAPTI (DOWN)\n"
            else
              MSG="${MSG}âœ… BACKEND: QAYTA ISHLAYAPTI (UP)\n"
            fi
          fi

          # \n larni haqiqiy yangi qatorga aylantirish
          MSG=$(printf "%b" "$MSG")

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
          --data-urlencode "chat_id=${TG_CHAT_ID}" \
          --data-urlencode "text=${MSG}"
