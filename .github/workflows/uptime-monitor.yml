name: Anfa Uptime Monitor

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Restore last status (cache)
        uses: actions/cache/restore@v4
        with:
          path: .monitor_state
          key: anfa-monitor-state-${{ github.run_id }}
          restore-keys: |
            anfa-monitor-state-

      - name: Ensure state folder exists
        run: mkdir -p .monitor_state

      - name: Read previous status
        id: prev
        run: |
          FE_PREV="unknown"
          BE_PREV="unknown"
          if [ -f .monitor_state/frontend.txt ]; then FE_PREV="$(cat .monitor_state/frontend.txt)"; fi
          if [ -f .monitor_state/backend.txt ]; then BE_PREV="$(cat .monitor_state/backend.txt)"; fi
          echo "fe_prev=$FE_PREV" >> $GITHUB_OUTPUT
          echo "be_prev=$BE_PREV" >> $GITHUB_OUTPUT

      - name: Check Frontend
        id: fe
        run: |
          set +e
          curl -fsS -m 15 https://anfa-feedback.uz >/dev/null
          if [ "$?" = "0" ]; then echo "status=up" >> $GITHUB_OUTPUT; else echo "status=down" >> $GITHUB_OUTPUT; fi

      - name: Check Backend
        id: be
        run: |
          set +e
          curl -fsS -m 15 https://api.anfa-feedback.uz/health >/dev/null
          if [ "$?" = "0" ]; then echo "status=up" >> $GITHUB_OUTPUT; else echo "status=down" >> $GITHUB_OUTPUT; fi

      - name: Save current status (files)
        run: |
          echo "${{ steps.fe.outputs.status }}" > .monitor_state/frontend.txt
          echo "${{ steps.be.outputs.status }}" > .monitor_state/backend.txt

      - name: Save state to cache
        uses: actions/cache/save@v4
        with:
          path: .monitor_state
          key: anfa-monitor-state-${{ github.run_id }}

      - name: Notify Telegram (only when status changes)
        if: steps.prev.outputs.fe_prev != steps.fe.outputs.status || steps.prev.outputs.be_prev != steps.be.outputs.status
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          FE_PREV="${{ steps.prev.outputs.fe_prev }}"
          BE_PREV="${{ steps.prev.outputs.be_prev }}"
          FE_NOW="${{ steps.fe.outputs.status }}"
          BE_NOW="${{ steps.be.outputs.status }}"

          MSG="ðŸ“¡ ANFA MONITORING OGÐžHLANTIRISHI
ðŸ•’ Vaqt (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')

"

          if [ "$FE_PREV" != "$FE_NOW" ]; then
            if [ "$FE_NOW" = "down" ]; then
              MSG="${MSG}ðŸš¨ FRONTEND: ISHLAMAYAPTI (DOWN)
"
            else
              MSG="${MSG}âœ… FRONTEND: QAYTA ISHLAYAPTI (UP)
"
            fi
          fi

          if [ "$BE_PREV" != "$BE_NOW" ]; then
            if [ "$BE_NOW" = "down" ]; then
              MSG="${MSG}ðŸš¨ BACKEND: ISHLAMAYAPTI (DOWN)
"
            else
              MSG="${MSG}âœ… BACKEND: QAYTA ISHLAYAPTI (UP)
"
            fi
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TG_CHAT_ID}" \
            --data-urlencode "text=${MSG}"
